<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>ChessPro Ultimate - Stockfish 15 & Anti-Cheat (Supabase)</title>

    <!-- Tailwind CSS CDN v·ªõi config ƒë·ªÉ gi·∫£m c·∫£nh b√°o -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {}
        }
      }
    </script>
    
    <!-- Chessboard CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css">
    
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

    <!-- Supabase client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script type="module">
      const ALLOWED_DOMAINS = ['localhost', '127.0.0.1', 'chesspro.com'];
      const currentDomain = window.location.hostname;
      
      const SUPABASE_CONFIG = {
        URL: "https://ikulfozqiwfxbnmlrosj.supabase.co",
        ANON_KEY: "sb_publishable_qm8XhUM-aCBrzXWXmu1xhg_N_KWXvtN",
      };
      
      if (!ALLOWED_DOMAINS.some(domain => currentDomain.includes(domain))) {
        console.warn('‚ö†Ô∏è ·ª®ng d·ª•ng ch·ªâ ƒë∆∞·ª£c ch·∫°y tr√™n c√°c domain ƒë∆∞·ª£c ph√©p');
      }
      
      window.supabase = window.supabase || Supabase.createClient(SUPABASE_CONFIG.URL, SUPABASE_CONFIG.ANON_KEY, {
        auth: { persistSession: false },
        realtime: {
            params: { eventsPerSecond: 10 }
        }
      });
    </script>

    <!-- Custom Styles -->
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
      
      :root {
        --primary-indigo: #4f46e5;
        --primary-emerald: #10b981;
        --primary-amber: #f59e0b;
        --bg-dark: #020617;
        --card-bg: rgba(15, 23, 42, 0.7);
      }
      
      body { 
        font-family: 'Plus Jakarta Sans', sans-serif; 
        background: var(--bg-dark); 
        color: #f1f5f9; 
        -webkit-tap-highlight-color: transparent;
        overflow-x: hidden;
        overscroll-behavior: none;
        position: fixed; 
        width: 100%;
        height: 100%;
        overflow-y: auto;
      }
      
      .bg-glow-layer {
        position: fixed;
        inset: 0;
        background: 
          radial-gradient(circle at 15% 25%, rgba(79,70,229,0.15) 0%, transparent 45%),
          radial-gradient(circle at 85% 75%, rgba(16,185,129,0.1) 0%, transparent 45%);
        z-index: -1;
        animation: floatGlow 12s infinite alternate ease-in-out;
        pointer-events: none;
      }
      
      @keyframes floatGlow {
        0% { transform: translate(0,0) scale(1); opacity: 0.7; }
        100% { transform: translate(1%,1%) scale(1.08); opacity: 1; }
      }
      
      .glass-card {
        background: var(--card-bg);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid rgba(255,255,255,0.1);
        transition: all 0.4s cubic-bezier(0.175,0.885,0.32,1.275);
      }
      
      .btn-mode-card {
        cursor: pointer;
        position: relative;
        overflow: hidden;
        transition: all 0.4s cubic-bezier(0.175,0.885,0.32,1.275);
      }
      
      .btn-mode-card:hover {
        transform: translateY(-8px) scale(1.02);
        border-color: rgba(99,102,241,0.5);
        box-shadow: 0 20px 40px -12px rgba(0,0,0,0.5), 0 0 20px rgba(99,102,241,0.2);
        background: rgba(30,41,59,0.8);
      }
      
      .board-container {
        display: flex;
        gap: 10px;
        align-items: stretch;
        justify-content: center;
        width: 100%;
        max-width: min(520px, 90vw);
        margin: 0 auto;
        touch-action: none;
      }
      
      .eval-bar-container {
        width: 24px;
        background: #333;
        border-radius: 4px;
        overflow: hidden;
        display: flex;
        flex-direction: column-reverse;
        position: relative;
        box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        border: 1px solid rgba(255,255,255,0.1);
      }
      
      .eval-bar-fill {
        background: linear-gradient(to top, #4f46e5, #818cf8);
        width: 100%;
        height: 50%;
        transition: height 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
      }
      
      #my-board {
        flex: 1;
        border-radius: 12px;
        overflow: hidden;
        border: 6px solid #1e293b;
        box-shadow: 0 20px 60px rgba(0,0,0,0.8);
        max-width: 100%;
        touch-action: none;
      }
      
      @media (max-width: 768px) {
        #my-board {
          border-width: 4px;
        }
      }
      
      .highlight-hint {
        background: radial-gradient(circle, rgba(99,102,241,0.7) 18%, transparent 22%) !important;
      }
      
      .highlight-move {
        background-color: rgba(99,102,241,0.3) !important;
        box-shadow: inset 0 0 15px rgba(99,102,241,0.3);
      }
      
      .highlight-selected {
        background-color: rgba(99,102,241,0.5) !important;
      }
      
      .king-check {
        background: radial-gradient(circle,#ef4444 30%,#7f1d1d 80%,transparent 100%) !important;
        animation: pulse-red 0.5s infinite alternate;
      }
      
      @keyframes pulse-red {
        from { opacity: 0.6; transform: scale(0.95); }
        to { opacity: 1; transform: scale(1.05); }
      }
      
      #toast.show {
        transform: translate(-50%, 0);
        opacity: 1;
      }
      
      .modal-overlay {
        background: rgba(2,6,23,0.95);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        z-index: 5000;
      }
      
      .fade-in {
        animation: fadeIn 0.5s cubic-bezier(0.23,1,0.32,1) forwards;
      }
      
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(30px); }
        to { opacity: 1; transform: translateY(0); }
      }
      
      .mic-active {
        animation: pulse-mic 1.5s infinite;
        background-color: #ef4444 !important;
        color: white !important;
        border-color: #ef4444 !important;
      }
      
      @keyframes pulse-mic {
        0% { box-shadow: 0 0 0 0 rgba(239,68,68,0.7); }
        70% { box-shadow: 0 0 0 12px rgba(239,68,68,0); }
        100% { box-shadow: 0 0 0 0 rgba(239,68,68,0); }
      }
      
      .control-btn {
        position: relative;
        overflow: hidden;
      }
      
      .control-btn::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        background: rgba(255,255,255,0.2);
        border-radius: 50%;
        transform: translate(-50%, -50%);
        transition: width 0.3s, height 0.3s;
      }
      
      .control-btn:active::after {
        width: 150%;
        height: 150%;
      }
      
      .cheat-warning {
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(239,68,68,0.9);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 10px;
        font-weight: 800;
        text-transform: uppercase;
        letter-spacing: 1px;
        z-index: 100;
        display: none;
        animation: shake 0.5s;
      }
      
      @keyframes shake {
        0%,100% { transform: translateX(-50%); }
        25% { transform: translateX(-55%); }
        75% { transform: translateX(-45%); }
      }
      
      .timer {
        font-size: 1.2rem;
        font-weight: bold;
        color: #fff;
        background: rgba(0,0,0,0.5);
        padding: 8px 12px;
        border-radius: 12px;
        min-width: 120px;
        text-align: center;
      }
      
      @media (max-width: 640px) {
        .timer {
          font-size: 1rem;
          padding: 6px 10px;
          min-width: 100px;
        }
      }
      
      #loading-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        display: none;
        backdrop-filter: blur(4px);
      }
      
      .spinner {
        animation: spin 1s linear infinite;
        border: 4px solid rgba(243, 243, 243, 0.2);
        border-top: 4px solid #4f46e5;
        border-radius: 50%;
        width: 50px;
        height: 50px;
      }
      
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      
      .mobile-only {
        display: none;
      }
      
      @media (max-width: 768px) {
        .mobile-only {
          display: block;
        }
        .desktop-only {
          display: none;
        }
        #game-screen .grid {
          grid-template-columns: 1fr !important;
        }
        .timer {
          margin: 4px 0;
        }
      }
      
      .promo-piece {
        width: 60px;
        height: 60px;
        transition: transform 0.2s;
      }
      
      .promo-piece:hover {
        transform: scale(1.1);
      }
      
      @media (max-width: 480px) {
        .promo-piece {
          width: 50px;
          height: 50px;
        }
      }
      
      .connection-status {
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
        z-index: 1000;
        transition: all 0.3s;
      }
      
      .connection-online {
        background: rgba(16, 185, 129, 0.9);
        color: white;
      }
      
      .connection-offline {
        background: rgba(239, 68, 68, 0.9);
        color: white;
      }
      
      .square-touch-active {
        opacity: 0.8 !important;
      }
      
      .debug-panel {
        position: fixed;
        bottom: 10px;
        left: 10px;
        background: rgba(0,0,0,0.7);
        color: #fff;
        padding: 5px 10px;
        border-radius: 5px;
        font-size: 10px;
        z-index: 9999;
        display: none;
      }
      
      /* Fix for Tailwind CDN warning */
      .hidden { display: none; }
      .flex { display: flex; }
      .grid { display: grid; }
      .block { display: block; }
    </style>
</head>
<body class="min-h-screen">
  <div class="bg-glow-layer"></div>

  <!-- Debug Panel -->
  <div id="debug-panel" class="debug-panel">
    State: <span id="debug-state">OK</span>
  </div>

  <!-- Loading Overlay -->
  <div id="loading-overlay">
    <div class="spinner"></div>
    <div class="absolute bottom-32 text-white text-center">
      <div id="loading-text" class="text-sm mt-4">ƒêang kh·ªüi t·∫°o...</div>
      <div id="loading-progress" class="w-64 h-2 bg-gray-700 rounded-full overflow-hidden mt-2">
        <div id="loading-bar" class="h-full bg-indigo-500 transition-all duration-300" style="width: 0%"></div>
      </div>
    </div>
  </div>

  <!-- Connection Status -->
  <div id="connection-status" class="connection-status connection-online hidden">
    <span class="flex items-center gap-2">
      <span class="w-2 h-2 rounded-full bg-white animate-pulse"></span>
      ƒêang k·∫øt n·ªëi...
    </span>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed top-10 left-1/2 -translate-x-1/2 z-[9999] bg-indigo-600 text-white px-6 py-3 rounded-xl font-bold opacity-0 transition-all duration-300 pointer-events-none uppercase text-[10px] tracking-widest text-center whitespace-nowrap shadow-2xl"></div>

  <!-- Landing Screen -->
  <div id="landing-screen" class="min-h-screen flex flex-col items-center justify-center p-6 fade-in gap-8 md:gap-10">
    <div class="text-center">
      <div class="mb-4 md:mb-6 w-16 h-16 md:w-20 md:h-20 bg-indigo-600 rounded-[20px] md:rounded-[24px] flex items-center justify-center shadow-2xl mx-auto rotate-12 hover:rotate-0 transition-transform duration-500">
        <i data-lucide="crown" class="w-8 h-8 md:w-10 md:h-10 text-white"></i>
      </div>
      <h1 class="text-4xl md:text-6xl lg:text-8xl font-black italic tracking-tighter uppercase text-white drop-shadow-2xl">
        Chess<span class="text-indigo-500">Pro</span>
      </h1>
      <p class="text-slate-500 font-bold uppercase tracking-[0.3em] md:tracking-[0.4em] text-[9px] md:text-[10px] mt-2">Stockfish 15 ‚Ä¢ Anti-Cheat</p>
    </div>

    <div class="w-full max-w-xs space-y-4">
      <input id="user-name-input" type="text" placeholder="T√™n k·ª≥ th·ªß..." class="w-full bg-slate-900/60 border border-slate-800 rounded-2xl py-4 md:py-5 px-6 focus:outline-none focus:border-indigo-500 font-bold text-center transition-all text-white shadow-inner" value="">
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8 w-full max-w-4xl">
      <div class="btn-mode-card glass-card p-6 md:p-8 lg:p-10 rounded-[32px] md:rounded-[40px] flex flex-col justify-center gap-6">
        <button id="btn-create" class="w-full bg-indigo-600 hover:bg-indigo-500 py-4 md:py-5 rounded-2xl font-black text-lg md:text-xl shadow-xl transition-all active:scale-95 uppercase text-white tracking-wider">
          T·∫°o Ph√≤ng Online
        </button>
        <div class="space-y-4">
          <input id="room-id-input" type="text" placeholder="M√É PH√íNG" class="w-full bg-slate-800/40 border border-slate-700/50 rounded-2xl py-4 md:py-5 px-4 uppercase text-center font-bold tracking-[0.2em] md:tracking-[0.3em] text-indigo-400 text-sm focus:outline-none">
          <div class="grid grid-cols-2 gap-4">
            <button id="btn-join" class="bg-indigo-500/10 hover:bg-indigo-500/20 text-indigo-400 py-3 md:py-4 rounded-2xl font-black text-[11px] md:text-[12px] uppercase border border-indigo-500/20 active:scale-95 transition-all">Tham Gia</button>
            <button id="btn-watch" class="bg-slate-800 hover:bg-slate-700 text-slate-300 py-3 md:py-4 rounded-2xl font-black text-[11px] md:text-[12px] uppercase active:scale-95 transition-all">Ch·ªâ Xem</button>
          </div>
        </div>
      </div>

      <div class="flex flex-col gap-6">
        <button id="btn-ai" class="btn-mode-card glass-card rounded-[32px] md:rounded-[40px] p-6 md:p-8 flex items-center gap-4 md:gap-8 border-emerald-500/10 text-white group w-full">
          <div class="icon-container w-16 h-16 md:w-20 md:h-20 bg-emerald-500/20 rounded-2xl md:rounded-3xl flex items-center justify-center text-emerald-500 transition-all duration-300 group-hover:scale-110">
            <i data-lucide="zap" class="w-8 h-8 md:w-10 md:h-10"></i>
          </div>
          <div class="text-left">
            <p class="font-black text-2xl md:text-3xl lg:text-4xl text-emerald-400 uppercase italic leading-none mb-1">ƒê·∫•u AI</p>
            <p class="text-[9px] md:text-[10px] text-slate-500 font-bold uppercase tracking-widest">SF 15 (1.5s)</p>
          </div>
        </button>

        <button id="btn-offline" class="btn-mode-card glass-card rounded-[32px] md:rounded-[40px] p-6 md:p-8 flex items-center gap-4 md:gap-8 border-amber-500/10 text-white group w-full">
          <div class="icon-container w-16 h-16 md:w-20 md:h-20 bg-amber-500/20 rounded-2xl md:rounded-3xl flex items-center justify-center text-amber-500 transition-all duration-300 group-hover:scale-110">
            <i data-lucide="users" class="w-8 h-8 md:w-10 md:h-10"></i>
          </div>
          <div class="text-left">
            <p class="font-black text-2xl md:text-3xl lg:text-4xl text-amber-400 uppercase italic leading-none mb-1">Offline</p>
            <p class="text-[9px] md:text-[10px] text-slate-500 font-bold uppercase tracking-widest">ƒê·∫•u t·∫°i ch·ªó</p>
          </div>
        </button>
      </div>
    </div>
    
    <!-- Quick Tutorial -->
    <div class="mt-8 text-center text-slate-500 text-xs max-w-md">
      <p class="mb-2">üéØ <span class="font-bold">M·∫πo nhanh:</span> Click qu√¢n ƒë·ªÉ ch·ªçn, click √¥ ƒë·ªÉ di chuy·ªÉn</p>
      <p>üé§ D√πng mic ƒë·ªÉ tr√≤ chuy·ªán tr·ª±c ti·∫øp v·ªõi ƒë·ªëi th·ªß (Online)</p>
    </div>
  </div>

  <!-- Game screen -->
  <div id="game-screen" class="hidden min-h-screen p-4 md:p-6 lg:p-8 fade-in">
    <div class="max-w-[1400px] mx-auto grid grid-cols-1 lg:grid-cols-[1fr,360px] gap-6 md:gap-8">
      <div class="flex flex-col gap-6">
        <header class="flex items-center justify-between glass-card p-4 md:p-5 rounded-[20px] md:rounded-[24px]">
          <div class="flex items-center gap-3 md:gap-4">
            <button id="btn-home" class="w-10 h-10 md:w-12 md:h-12 bg-slate-800 rounded-xl md:rounded-2xl flex items-center justify-center text-slate-400 hover:text-white transition-all hover:rotate-[-10deg] active:scale-95" title="V·ªÅ trang ch·ªß">
              <i data-lucide="home" class="w-5 h-5 md:w-6 md:h-6"></i>
            </button>
            <div>
              <div class="flex items-center gap-2 flex-wrap">
                <h2 id="room-display" class="font-black text-base md:text-lg text-indigo-400 uppercase italic">OFFLINE</h2>
                <button id="btn-copy" class="text-slate-600 hover:text-white transition-colors p-1" title="Copy m√£ ph√≤ng">
                  <i data-lucide="copy" class="w-4 h-4"></i>
                </button>
                <!-- Local time -->
                <div id="local-time" class="ml-2 md:ml-4 text-slate-400 text-xs md:text-sm"></div>
              </div>
              <p id="role-display" class="text-[8px] md:text-[9px] font-bold uppercase text-slate-500 tracking-widest">B·∫†N ƒêANG CH∆†I</p>
            </div>
          </div>

          <div class="flex items-center gap-2 md:gap-3">
            <button id="btn-mic" class="control-btn w-10 h-10 md:w-12 md:h-12 bg-slate-800 hover:bg-slate-700 rounded-xl md:rounded-2xl flex items-center justify-center text-white transition-all border border-transparent" title="B·∫≠t/T·∫Øt microphone">
              <i id="mic-icon" data-lucide="mic-off" class="w-4 h-4 md:w-5 md:h-5"></i>
            </button>
            <button id="btn-sound-toggle" class="control-btn w-10 h-10 md:w-12 md:h-12 bg-slate-800 hover:bg-indigo-600 rounded-xl md:rounded-2xl flex items-center justify-center text-white transition-all" title="B·∫≠t/T·∫Øt √¢m thanh">
              <i id="sound-icon" data-lucide="volume-2" class="w-5 h-5 md:w-6 md:h-6"></i>
            </button>
            <button id="btn-help" class="control-btn w-10 h-10 md:w-12 md:h-12 bg-slate-800 hover:bg-emerald-600 rounded-xl md:rounded-2xl flex items-center justify-center text-white transition-all hidden md:flex" title="Tr·ª£ gi√∫p">
              <i data-lucide="help-circle" class="w-5 h-5 md:w-6 md:h-6"></i>
            </button>
            <div id="check-tag" class="hidden bg-red-600 px-3 py-1.5 md:px-4 md:py-2 rounded-lg md:rounded-xl text-[10px] md:text-[11px] font-black animate-pulse uppercase tracking-widest ml-2 md:ml-3 text-white shadow-lg">CHI·∫æU!</div>
          </div>
        </header>

        <div class="flex justify-center items-center py-2 md:py-4 relative">
          <div id="cheat-alert" class="cheat-warning">ƒê·ªêI TH·ª¶ R·ªúI TAB!</div>
          <div class="board-container">
            <div id="adv-bar" class="eval-bar-container hidden">
              <div id="eval-fill" class="eval-bar-fill"></div>
            </div>
            <div id="my-board"></div>
          </div>
        </div>

        <div class="glass-card p-4 md:p-6 lg:p-8 rounded-[32px] md:rounded-[40px] flex flex-col md:flex-row flex-wrap items-center justify-between gap-4 md:gap-6 shadow-xl">
          <div class="flex items-center gap-4 md:gap-6 order-1">
            <div id="turn-box" class="w-12 h-12 md:w-16 md:h-16 bg-slate-800 rounded-2xl md:rounded-3xl flex items-center justify-center transition-all shadow-2xl">
              <i data-lucide="swords" class="w-6 h-6 md:w-8 md:h-8 text-white"></i>
            </div>
            <div>
              <p id="p-name-display" class="font-black text-xl md:text-2xl uppercase italic text-indigo-500 leading-tight">...</p>
              <p id="p-status" class="text-[10px] md:text-[11px] font-bold text-slate-500 uppercase tracking-widest">L∆Ø·ª¢T ƒêI</p>
            </div>
          </div>

          <div class="flex gap-2 md:gap-4 order-3 md:order-2 mt-4 md:mt-0 w-full md:w-auto justify-center">
            <button id="btn-flip" class="w-12 h-12 md:w-14 md:h-14 flex items-center justify-center bg-slate-800 hover:bg-slate-700 rounded-2xl transition-all text-white active:scale-95" title="Xoay b√†n c·ªù">
              <i data-lucide="refresh-cw" class="w-5 h-5 md:w-6 md:h-6"></i>
            </button>
            <button id="btn-resign" class="px-4 py-3 md:px-6 md:py-4 bg-red-500/10 hover:bg-red-500/20 text-red-500 rounded-2xl font-black text-[11px] md:text-[12px] uppercase border border-red-500/20 active:scale-95 transition-all">ƒê·∫ßu h√†ng</button>
            <button id="btn-draw" class="px-4 py-3 md:px-6 md:py-4 bg-amber-500/10 hover:bg-amber-500/20 text-amber-400 rounded-2xl font-black text-[11px] md:text-[12px] uppercase border border-amber-500/20 active:scale-95 transition-all">Y√™u c·∫ßu h√≤a</button>
          </div>
          
          <div class="flex flex-col md:flex-row gap-2 md:gap-4 order-2 md:order-3 mt-4 md:mt-0 w-full md:w-auto justify-center">
            <div id="timer-white" class="timer">Tr·∫Øng: <span class="text-emerald-300">10:00</span></div>
            <div id="timer-black" class="timer">ƒêen: <span class="text-emerald-300">10:00</span></div>
          </div>
        </div>
        
        <!-- Mobile Controls -->
        <div class="mobile-only glass-card p-4 rounded-2xl flex justify-center gap-4 mt-2">
          <button id="btn-undo-mobile" class="px-4 py-3 bg-slate-800 text-slate-300 rounded-xl font-bold text-sm active:scale-95 transition-all">Ho√†n t√°c</button>
          <button id="btn-hint-mobile" class="px-4 py-3 bg-indigo-600 text-white rounded-xl font-bold text-sm active:scale-95 transition-all">G·ª£i √Ω</button>
        </div>
      </div>

      <!-- Chat & history -->
      <div class="flex flex-col gap-6 h-full">
        <div class="glass-card rounded-[28px] md:rounded-[32px] p-4 md:p-6 h-[180px] md:h-[220px] flex flex-col shadow-lg">
          <div class="flex justify-between items-center mb-3 md:mb-4">
            <h3 class="text-[10px] md:text-[11px] font-black text-slate-500 uppercase tracking-widest">Bi√™n b·∫£n</h3>
            <span id="eval-score" class="text-[9px] md:text-[10px] font-bold text-emerald-400 bg-emerald-500/10 px-2 py-1 rounded">0.0</span>
          </div>
          <div id="history-box" class="flex-1 overflow-y-auto grid grid-cols-2 md:grid-cols-3 gap-2 content-start pr-2">
            <!-- Moves will be inserted here -->
          </div>
        </div>

        <div class="glass-card rounded-[28px] md:rounded-[32px] flex flex-col flex-1 min-h-[400px] lg:min-h-0 overflow-hidden shadow-2xl">
          <div class="p-4 md:p-5 border-b border-white/5 bg-white/5 flex justify-between items-center">
            <span class="text-[10px] md:text-[11px] font-black uppercase text-indigo-400 tracking-widest">Ph√≤ng Chat</span>
            <div id="online-count" class="text-[9px] md:text-[10px] font-bold text-emerald-500 flex items-center gap-2 bg-emerald-500/10 px-2 py-1 md:px-3 md:py-1.5 rounded-full">
              <span class="w-2 h-2 bg-emerald-500 rounded-full animate-ping"></span> 
              <span id="online-count-text">0 Online</span>
            </div>
          </div>

          <div id="players-list" class="p-4 md:p-5 border-b border-white/5 bg-white/5 flex flex-col gap-2 max-h-32 overflow-y-auto">
            <!-- Players will be listed here -->
          </div>

          <div id="chat-box" class="flex-1 p-4 md:p-5 space-y-4 overflow-y-auto bg-slate-900/40">
            <!-- Chat messages will appear here -->
          </div>

          <div class="p-3 md:p-4 bg-slate-900/80 border-t border-white/5 flex gap-2 md:gap-3">
            <input id="chat-input" type="text" placeholder="Nh·∫≠p tin nh·∫Øn..." class="flex-1 bg-slate-800 border-none rounded-2xl py-3 md:py-4 px-4 md:px-5 text-[13px] md:text-[14px] text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all" maxlength="200">
            <button id="btn-send" class="bg-indigo-600 text-white w-12 h-12 md:w-14 md:h-14 rounded-2xl hover:bg-indigo-500 transition-all flex items-center justify-center shadow-lg active:scale-95">
              <i data-lucide="send" class="w-4 h-4 md:w-5 md:h-5"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Promotion modal -->
  <div id="promotion-modal" class="hidden fixed inset-0 modal-overlay flex items-center justify-center p-4 md:p-6">
    <div class="glass-card p-6 md:p-8 lg:p-10 rounded-[32px] md:rounded-[48px] max-w-sm w-full text-center fade-in text-white">
      <h3 class="text-2xl md:text-3xl font-black italic uppercase mb-6 md:mb-10 text-indigo-400 tracking-tighter">Phong C·∫•p</h3>
      <div class="grid grid-cols-2 gap-3 md:gap-4">
        <button id="promo-q-btn" class="bg-white/5 hover:bg-indigo-600/20 p-4 md:p-6 lg:p-8 rounded-[24px] md:rounded-[32px] transition-all active:scale-95">
          <img id="promo-q-img" src="" class="promo-piece mx-auto" alt="H·∫≠u">
        </button>
        <button id="promo-r-btn" class="bg-white/5 hover:bg-indigo-600/20 p-4 md:p-6 lg:p-8 rounded-[24px] md:rounded-[32px] transition-all active:scale-95">
          <img id="promo-r-img" src="" class="promo-piece mx-auto" alt="Xe">
        </button>
        <button id="promo-b-btn" class="bg-white/5 hover:bg-indigo-600/20 p-4 md:p-6 lg:p-8 rounded-[24px] md:rounded-[32px] transition-all active:scale-95">
          <img id="promo-b-img" src="" class="promo-piece mx-auto" alt="T∆∞·ª£ng">
        </button>
        <button id="promo-n-btn" class="bg-white/5 hover:bg-indigo-600/20 p-4 md:p-6 lg:p-8 rounded-[24px] md:rounded-[32px] transition-all active:scale-95">
          <img id="promo-n-img" src="" class="promo-piece mx-auto" alt="M√£">
        </button>
      </div>
      <p class="text-slate-400 text-xs mt-4 md:mt-6">Ch·ªçn qu√¢n ƒë·ªÉ phong c·∫•p</p>
    </div>
  </div>

  <!-- Draw modal -->
  <div id="draw-request-modal" class="hidden fixed inset-0 modal-overlay flex items-center justify-center p-4 md:p-6">
    <div class="glass-card p-6 md:p-8 rounded-[32px] md:rounded-[40px] max-w-sm w-full text-center fade-in text-white">
      <h3 class="text-xl md:text-2xl font-black italic uppercase mb-4 text-indigo-300">Y√äU C·∫¶U H√íA</h3>
      <p id="draw-request-from" class="text-slate-300 mb-4 md:mb-6 text-sm md:text-base">Ng∆∞·ªùi ch∆°i X y√™u c·∫ßu h√≤a.</p>
      <div class="flex gap-3 md:gap-4 justify-center">
        <button id="btn-draw-accept" class="px-5 md:px-6 py-2.5 md:py-3 bg-emerald-500 hover:bg-emerald-600 rounded-xl md:rounded-2xl font-black text-sm md:text-base">ƒê·ªìng √Ω</button>
        <button id="btn-draw-decline" class="px-5 md:px-6 py-2.5 md:py-3 bg-red-500 hover:bg-red-600 rounded-xl md:rounded-2xl font-black text-sm md:text-base">T·ª´ ch·ªëi</button>
      </div>
      <p class="text-slate-500 text-xs mt-4">T·ª± ƒë·ªông t·ª´ ch·ªëi sau <span id="draw-timeout">20</span>s</p>
    </div>
  </div>

  <!-- Endgame modal -->
  <div id="endgame-modal" class="hidden fixed inset-0 modal-overlay flex items-center justify-center p-4 md:p-6">
    <div class="glass-card p-6 md:p-8 lg:p-12 rounded-[32px] md:rounded-[48px] lg:rounded-[56px] max-w-sm w-full text-center fade-in text-white border-white/20">
      <h2 id="endgame-title" class="text-3xl md:text-4xl lg:text-5xl font-black italic uppercase mb-3 md:mb-4 tracking-tighter">K·∫æT TH√öC</h2>
      <p id="endgame-desc" class="text-slate-400 font-bold text-[10px] md:text-[11px] mb-6 md:mb-8 lg:mb-12 uppercase tracking-[0.3em] md:tracking-[0.4em]">...</p>
      <div class="space-y-3 md:space-y-4">
        <button id="btn-endgame-home" class="w-full bg-indigo-600 hover:bg-indigo-500 py-3 md:py-4 lg:py-5 rounded-xl md:rounded-2xl font-black uppercase text-[12px] md:text-[13px] shadow-2xl tracking-widest active:scale-95 transition-all">V·ªÅ Trang Ch·ªß</button>
        <button id="btn-replay" class="w-full bg-emerald-600 hover:bg-emerald-500 py-3 md:py-4 lg:py-5 rounded-xl md:rounded-2xl font-black uppercase text-[12px] md:text-[13px] shadow-2xl tracking-widest active:scale-95 transition-all">Ch∆°i L·∫°i</button>
        <button id="btn-analyze" class="w-full bg-slate-800 hover:bg-slate-700 py-3 md:py-4 lg:py-5 rounded-xl md:rounded-2xl font-black uppercase text-[12px] md:text-[13px] tracking-widest active:scale-95 transition-all">Copy PGN (Ph√¢n t√≠ch)</button>
      </div>
    </div>
  </div>

  <!-- Help modal -->
  <div id="help-modal" class="hidden fixed inset-0 modal-overlay flex items-center justify-center p-4 md:p-6">
    <div class="glass-card p-6 md:p-8 rounded-[32px] max-w-2xl w-full max-h-[80vh] overflow-y-auto fade-in text-white">
      <h3 class="text-2xl font-black italic uppercase mb-6 text-indigo-400">H∆∞·ªõng D·∫´n</h3>
      <div class="space-y-4 text-sm">
        <div>
          <h4 class="font-bold text-emerald-400 mb-2">üéÆ C√°ch Ch∆°i:</h4>
          <ul class="list-disc pl-5 space-y-1 text-slate-300">
            <li>Click qu√¢n ƒë·ªÉ ch·ªçn, click √¥ ƒë·ªÉ di chuy·ªÉn</li>
            <li>K√©o th·∫£ tr√™n ƒëi·ªán tho·∫°i/tablet</li>
            <li>Phong c·∫•p: Ch·ªçn qu√¢n khi t·ªët ƒë·∫øn cu·ªëi b√†n</li>
          </ul>
        </div>
        <div>
          <h4 class="font-bold text-amber-400 mb-2">‚öôÔ∏è Ch·ª©c NƒÉng:</h4>
          <ul class="list-disc pl-5 space-y-1 text-slate-300">
            <li><span class="text-indigo-400">Mic:</span> Tr√≤ chuy·ªán tr·ª±c ti·∫øp (Online)</li>
            <li><span class="text-indigo-400">Xoay b√†n:</span> L·∫≠t b√†n c·ªù theo g√≥c nh√¨n</li>
            <li><span class="text-indigo-400">Thanh ƒë√°nh gi√°:</span> L·ª£i th·∫ø c·ªßa b√™n Tr·∫Øng/ƒêen</li>
          </ul>
        </div>
        <div>
          <h4 class="font-bold text-red-400 mb-2">üö´ Anti-Cheat:</h4>
          <p class="text-slate-300">H·ªá th·ªëng c·∫£nh b√°o khi ƒë·ªëi th·ªß r·ªùi tab qu√° nhi·ªÅu l·∫ßn</p>
        </div>
        <div class="pt-4 border-t border-white/10">
          <button id="btn-close-help" class="w-full bg-slate-800 hover:bg-slate-700 py-3 rounded-2xl font-bold transition-all">ƒê√≥ng</button>
        </div>
      </div>
    </div>
  </div>

  <!-- MAIN SCRIPT v·ªõi Stockfish 15 -->
  <script>
  (function () {
    'use strict';
    
    // ==================== CONFIGURATION ====================
    const PIECE_IMAGES = {
      'wP': 'https://upload.wikimedia.org/wikipedia/commons/4/45/Chess_plt45.svg',
      'wR': 'https://upload.wikimedia.org/wikipedia/commons/7/72/Chess_rlt45.svg',
      'wN': 'https://upload.wikimedia.org/wikipedia/commons/7/70/Chess_nlt45.svg',
      'wB': 'https://upload.wikimedia.org/wikipedia/commons/b/b1/Chess_blt45.svg',
      'wQ': 'https://upload.wikimedia.org/wikipedia/commons/1/15/Chess_qlt45.svg',
      'wK': 'https://upload.wikimedia.org/wikipedia/commons/4/42/Chess_klt45.svg',
      'bP': 'https://upload.wikimedia.org/wikipedia/commons/c/c7/Chess_pdt45.svg',
      'bR': 'https://upload.wikimedia.org/wikipedia/commons/f/ff/Chess_rdt45.svg',
      'bN': 'https://upload.wikimedia.org/wikipedia/commons/e/ef/Chess_ndt45.svg',
      'bB': 'https://upload.wikimedia.org/wikipedia/commons/9/98/Chess_bdt45.svg',
      'bQ': 'https://upload.wikimedia.org/wikipedia/commons/4/47/Chess_qdt45.svg',
      'bK': 'https://upload.wikimedia.org/wikipedia/commons/f/f0/Chess_kdt45.svg'
    };

    // SOUNDS
    const SOUNDS_URL = {
      move: 'https://images.chesscomfiles.com/chess-themes/sounds/_MP3_/default/move-self.mp3',
      capture: 'https://images.chesscomfiles.com/chess-themes/sounds/_MP3_/default/capture.mp3',
      check: 'https://images.chesscomfiles.com/chess-themes/sounds/_MP3_/default/move-check.mp3',
      gameover: 'https://images.chesscomfiles.com/chess-themes/sounds/_MP3_/default/game-end.mp3',
      notify: 'https://images.chesscomfiles.com/chess-themes/sounds/_MP3_/default/notify.mp3'
    };
    
    // ==================== STOCKFISH 15 ====================
    const STOCKFISH_URL = 'https://cdn.jsdelivr.net/npm/stockfish@15.0.0/src/stockfish.min.js';
    
    // ==================== LOGGER ====================
    const logger = {
      log: (type, data) => {
        if (window.location.hostname.includes('localhost')) {
          console.log(`[ChessPro] ${type}:`, data);
          const debugState = document.getElementById('debug-state');
          if (debugState) debugState.textContent = type;
        }
      },
      error: (error, context) => {
        console.error(`[ChessPro Error] ${context}:`, error);
      }
    };
    
    // ==================== STATE MANAGEMENT ====================
    let state = {
      game: null,
      board: null,
      mode: 'offline',
      role: 'spectator',
      orientation: 'white',
      stockfish: null,
      
      user: {
        id: localStorage.getItem('cp_uid') || `u-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
        name: localStorage.getItem('cp_name') || ''
      },
      
      roomId: null,
      channel: null,
      
      audioUnlocked: false,
      soundEnabled: true,
      thinking: false,
      pendingMove: null,
      
      timerInterval: null,
      whiteTime: 600000,
      blackTime: 600000,
      lastTick: 0,
      
      eventQueue: [],
      processingEvent: false,
      
      reconnectAttempts: 0,
      MAX_RECONNECT_ATTEMPTS: 5
    };

    // Save ID
    localStorage.setItem('cp_uid', state.user.id);
    
    // ==================== AUDIO SYSTEM ====================
    const audioElements = {};
    
    async function initAudio() {
      try {
        for (const [key, url] of Object.entries(SOUNDS_URL)) {
          try {
            const audio = new Audio();
            audio.src = url;
            audio.preload = 'auto';
            audio.load();
            audioElements[key] = audio;
          } catch (e) {
            logger.error(e, `create_audio_${key}`);
          }
        }
        
        unlockAudio();
        
      } catch (e) {
        logger.error(e, 'audio_init');
      }
    }

    function unlockAudio() {
      if (state.audioUnlocked) return;
      
      try {
        const silentAudio = new Audio();
        silentAudio.volume = 0.001;
        silentAudio.play().then(() => {
          silentAudio.pause();
          silentAudio.currentTime = 0;
        }).catch(() => {});
        
        state.audioUnlocked = true;
      } catch (e) {
        logger.error(e, 'audio_unlock');
      }
    }

    function playSound(key) {
      if (!state.soundEnabled || !audioElements[key]) return;
      
      try {
        const audio = audioElements[key];
        audio.currentTime = 0;
        audio.volume = 0.4;
        audio.play().catch(e => {
          if (e.name === 'NotAllowedError') {
            unlockAudio();
          }
        });
      } catch(e) {
        logger.error(e, 'play_sound');
      }
    }

    // ==================== LOADING SYSTEM ====================
    function showLoading(step, totalSteps = 5) {
      const progress = Math.round((step / totalSteps) * 100);
      const loadingBar = document.getElementById('loading-bar');
      if (loadingBar) loadingBar.style.width = `${progress}%`;
      
      const messages = {
        1: 'ƒêang kh·ªüi t·∫°o game engine...',
        2: 'ƒêang t·∫£i b√†n c·ªù...',
        3: 'ƒêang k·∫øt n·ªëi server...',
        4: 'ƒêang thi·∫øt l·∫≠p √¢m thanh...',
        5: 'S·∫µn s√†ng!'
      };
      
      const loadingText = document.getElementById('loading-text');
      if (loadingText) loadingText.textContent = messages[step] || 'ƒêang t·∫£i...';
    }

    function showLoadingOverlay(show) {
      const overlay = document.getElementById('loading-overlay');
      if (overlay) {
        overlay.style.display = show ? 'flex' : 'none';
      }
    }

    // ==================== STOCKFISH 15 ====================
    async function initStockfish() {
      if (state.stockfish) return true;

      try {
        showLoading(1, 5);
        
        console.log('üîß ƒêang t·∫£i Stockfish 15 t·ª´:', STOCKFISH_URL);
        
        const response = await fetch(STOCKFISH_URL);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const blob = await response.blob();
        const blobUrl = URL.createObjectURL(blob);
        state.stockfish = new Worker(blobUrl);
        
        // Cleanup blob URL
        setTimeout(() => URL.revokeObjectURL(blobUrl), 1000);
        
        console.log('‚úÖ Stockfish 15 Worker ƒë√£ ƒë∆∞·ª£c t·∫°o');
        
        // Thi·∫øt l·∫≠p message handler
        state.stockfish.onmessage = (e) => {
          const msg = e.data;
          
          if (msg === 'readyok') {
            logger.log('stockfish', 'ready');
            showLoading(2, 5);
          }
          
          if (msg.startsWith('bestmove') && state.mode === 'ai' && state.game.turn() === 'b') {
            const moveStr = msg.split(' ')[1];
            if (moveStr && moveStr !== '(none)') {
              const from = moveStr.substring(0, 2);
              const to = moveStr.substring(2, 4);
              const promotion = moveStr.length > 4 ? moveStr.substring(4, 5) : 'q';
              
              state.thinking = false;
              updateUI();
              makeMove({from, to, promotion});
            }
          }
          
          if (msg.includes('score cp') || msg.includes('score mate')) {
            updateEval(msg);
          }
        };

        state.stockfish.onerror = (e) => {
          logger.error(e, 'stockfish_worker');
          showToast("L·ªói AI Engine");
          if (state.reconnectAttempts < 3) {
            initStockfish();
            state.reconnectAttempts++;
          } else {
            showToast('AI Error - Kh√¥ng th·ªÉ k·∫øt n·ªëi');
          }
        };

        // T·ªëi ∆∞u UCI options tr∆∞·ªõc UCI
        // Detect threads: Max 4 ƒë·ªÉ an to√†n trong browser
        const maxThreads = Math.min(4, navigator.hardwareConcurrency || 1);
        state.stockfish.postMessage(`setoption name Threads value ${maxThreads}`);
        state.stockfish.postMessage('setoption name Hash value 128'); // 128MB balanced
        state.stockfish.postMessage('setoption name Skill Level value 20'); // Max strength
        state.stockfish.postMessage('setoption name UCI_LimitStrength value false');
        state.stockfish.postMessage('setoption name Move Overhead value 0');
        state.stockfish.postMessage('setoption name Minimum Thinking Time value 0');
        state.stockfish.postMessage('setoption name Slow Mover value 100'); // Default, balance
        state.stockfish.postMessage('setoption name Ponder value false'); // Kh√¥ng c·∫ßn

        // Kh·ªüi t·∫°o UCI
        state.stockfish.postMessage('uci');
        state.stockfish.postMessage('isready');
        
        return true;
      } catch (err) {
        logger.error(err, 'stockfish_init');
        showToast("Kh√¥ng th·ªÉ t·∫£i AI (L·ªói m·∫°ng)");
        return false;
      }
    }

    function askAI() {
      if (!state.stockfish || state.game.game_over() || state.thinking) return;
      
      state.thinking = true;
      updateUI();
      
      // Set MultiPV=1 cho move nhanh m·∫°nh
      state.stockfish.postMessage('setoption name MultiPV value 1');
      
      state.stockfish.postMessage(`position fen ${state.game.fen()}`);
      state.stockfish.postMessage('go movetime 1500'); // 1.5s fixed
      
      logger.log('ai_think', 'started');
    }

    function updateEval(msg) {
      let score = 0;
      if (msg.includes('score mate')) {
        const match = msg.match(/score mate (-?\d+)/);
        if (match) {
          score = parseInt(match[1]) > 0 ? 100 : -100;
        }
      } else {
        const match = msg.match(/cp (-?\d+)/);
        if (match) {
          let val = parseInt(match[1]);
          if (state.game.turn() === 'b') val = -val;
          score = Math.max(-100, Math.min(100, val / 10));
        }
      }
      
      const fill = document.getElementById('eval-fill');
      const scoreEl = document.getElementById('eval-score');
      const percent = 50 + (score / 2);
      
      if (fill) {
        fill.style.height = `${Math.max(5, Math.min(95, percent))}%`;
        fill.style.background = score >= 0 
          ? 'linear-gradient(to top, #4f46e5, #818cf8)' 
          : 'linear-gradient(to top, #dc2626, #ef4444)';
      }
      if (scoreEl) scoreEl.innerText = (score > 0 ? '+' : '') + (score/10).toFixed(1);
    }

    // ==================== GAME FUNCTIONS ====================
    function initBoard() {
      if (typeof Chessboard === 'undefined') {
        logger.error('Chessboard lib not loaded', 'init_board');
        showToast("L·ªói th∆∞ vi·ªán b√†n c·ªù!");
        setTimeout(initBoard, 500);
        return;
      }

      if (state.board) {
        state.board.destroy();
      }

      if (!state.game) {
        state.game = new Chess();
      }

      state.board = Chessboard('my-board', {
        draggable: true,
        position: state.game.fen(),
        pieceTheme: (p) => PIECE_IMAGES[p],
        orientation: state.orientation,
        onDragStart: (source, piece) => {
          if (state.game.game_over()) return false;
          if (state.mode === 'ai' && state.game.turn() === 'b') return false;
          if (state.mode === 'online') {
            if (state.role === 'spectator') return false;
            if (state.role === 'white' && piece.startsWith('b')) return false;
            if (state.role === 'black' && piece.startsWith('w')) return false;
            if (state.role !== 'spectator' && state.game.turn().charAt(0) !== state.role.charAt(0)) return false;
          }
          if ((state.game.turn() === 'w' && piece.startsWith('b')) ||
              (state.game.turn() === 'b' && piece.startsWith('w'))) return false;
          
          return true;
        },
        onDrop: (source, target) => {
          const moveObj = { from: source, to: target, promotion: 'q' };
          
          const tempGame = new Chess(state.game.fen());
          const move = tempGame.move(moveObj);
          
          if (move === null) {
            const moves = tempGame.moves({verbose: true});
            const isPromo = moves.some(m => m.from === source && m.to === target && m.flags.includes('p'));
            if (isPromo) {
              state.pendingMove = { from: source, to: target };
              showPromotionModal(state.game.turn());
              return 'snapback';
            }
            return 'snapback';
          }
          
          makeMove(moveObj);
          return 'snapback';
        },
        onSnapEnd: () => {
          state.board.position(state.game.fen());
        }
      });
      
      setTimeout(() => {
        if (state.board && state.board.resize) {
          state.board.resize();
        }
      }, 100);
    }

    function makeMove(moveObj) {
      if (!state.game) return false;
      
      try {
        const move = state.game.move(moveObj);
        if (!move) return false;

        updateBoard();
        
        if (move.flags.includes('c')) {
          playSound('capture');
        } else if (state.game.in_check()) {
          playSound('check');
        } else {
          playSound('move');
        }

        if (state.mode === 'online') {
          sendOnlineMove(moveObj);
        } else if (state.mode === 'ai' && state.game.turn() === 'b') {
          setTimeout(askAI, 500);
        } else if (state.mode === 'offline' && state.stockfish) {
          state.stockfish.postMessage(`position fen ${state.game.fen()}`);
          state.stockfish.postMessage('go depth 10');
        }
        
        return true;
      } catch (e) {
        logger.error(e, 'makeMove');
        return false;
      }
    }

    function updateBoard() {
      if (!state.board || !state.game) return;
      
      try {
        state.board.position(state.game.fen());
        updateUI();
        
        $('.square-55d63').removeClass('highlight-move king-check');
        const hist = state.game.history({verbose: true});
        if (hist.length > 0) {
          const last = hist[hist.length-1];
          $(`.square-${last.from}`).addClass('highlight-move');
          $(`.square-${last.to}`).addClass('highlight-move');
        }

        if (state.game.in_check()) {
          const board = state.game.board();
          for(let r=0; r<8; r++){
            for(let c=0; c<8; c++){
              if(board[r][c] && board[r][c].type === 'k' && board[r][c].color === state.game.turn()){
                const sq = String.fromCharCode(97+c) + (8-r);
                $(`.square-${sq}`).addClass('king-check');
              }
            }
          }
          $('#check-tag').removeClass('hidden');
        } else {
          $('#check-tag').addClass('hidden');
        }

        if (state.game.game_over()) {
          handleGameOver();
        }
      } catch (e) {
        logger.error(e, 'updateBoard');
      }
    }

    function updateUI() {
      if (!state.game) return;
      
      const turn = state.game.turn() === 'w' ? 'TR·∫ÆNG' : 'ƒêEN';
      let statusText = `L∆Ø·ª¢T ${turn}`;
      if (state.thinking) statusText = "AI ƒêANG NGHƒ®...";
      if (state.mode === 'online' && state.role === 'spectator') statusText = "ƒêANG XEM";
      
      $('#p-status').text(statusText);
      
      const turnBox = document.getElementById('turn-box');
      if (turnBox) {
        turnBox.style.background = state.game.turn() === 'w' ? '#e2e8f0' : '#1e293b';
        const icon = turnBox.querySelector('i');
        if (icon) {
          icon.style.color = state.game.turn() === 'w' ? '#000' : '#fff';
        }
      }

      const hist = state.game.history();
      let html = '';
      for(let i=0; i<hist.length; i+=2) {
        html += `<div class="bg-indigo-500/5 p-2 rounded-lg text-center font-bold text-indigo-400 text-[10px] border border-white/5 shadow-sm">
          <span class="text-slate-500 mr-1">${Math.floor(i/2)+1}.</span>${hist[i]}
        </div>`;
        if (hist[i+1]) {
          html += `<div class="bg-indigo-500/5 p-2 rounded-lg text-center font-bold text-indigo-400 text-[10px] border border-white/5 shadow-sm">
            ${hist[i+1]}
          </div>`;
        }
      }
      $('#history-box').html(html);
      $('#history-box').scrollTop($('#history-box')[0].scrollHeight);
    }

    function handleGameOver() {
      clearInterval(state.timerInterval);
      playSound('gameover');
      
      let title = "H√íA C·ªú";
      let desc = "V√°n ƒë·∫•u k·∫øt th√∫c h√≤a";
      
      if (state.game.in_checkmate()) {
        title = state.game.turn() === 'w' ? "ƒêEN TH·∫ÆNG" : "TR·∫ÆNG TH·∫ÆNG";
        desc = "Chi·∫øu h·∫øt (Checkmate)";
      } else if (state.game.in_stalemate()) {
        desc = "H·∫øt n∆∞·ªõc ƒëi (Stalemate)";
      } else if (state.game.insufficient_material()) {
        desc = "Kh√¥ng ƒë·ªß qu√¢n (Insufficient material)";
      }

      $('#endgame-title').text(title);
      $('#endgame-desc').text(desc);
      $('#endgame-modal').removeClass('hidden');
    }

    function showPromotionModal(color) {
      const pieceColor = color === 'w' ? 'w' : 'b';
      
      $('#promo-q-img').attr('src', PIECE_IMAGES[pieceColor + 'Q']);
      $('#promo-r-img').attr('src', PIECE_IMAGES[pieceColor + 'R']);
      $('#promo-b-img').attr('src', PIECE_IMAGES[pieceColor + 'B']);
      $('#promo-n-img').attr('src', PIECE_IMAGES[pieceColor + 'N']);
      
      $('#promotion-modal').removeClass('hidden');
    }

    // ==================== ONLINE SYNC ====================
    async function setupRoom(roomId, action) {
      cleanupGame();
      
      state.mode = 'online';
      state.roomId = roomId.toUpperCase();
      
      showLoading(3, 5);
      
      try {
        state.channel = supabase.channel(roomId, {
          config: { 
            presence: { key: state.user.id },
            broadcast: { ack: true }
          }
        });

        state.channel
          .on('presence', { event: 'sync' }, () => {
            const users = Object.values(state.channel.presenceState()).flat();
            users.sort((a,b) => (a.joinedAt || 0) - (b.joinedAt || 0));
            
            const myIdx = users.findIndex(u => u.user_id === state.user.id);
            if (action === 'watch') {
              state.role = 'spectator';
            } else {
              if (myIdx === 0) state.role = 'white';
              else if (myIdx === 1) state.role = 'black';
              else state.role = 'spectator';
            }
            state.orientation = state.role === 'black' ? 'black' : 'white';
            
            $('#online-count-text').text(`${users.length} Online`);
            $('#room-display').text(roomId);
            $('#role-display').text(`B·∫†N L√Ä: ${state.role.toUpperCase()}`);
            
            const playerList = users.map(u => `
              <div class="flex items-center justify-between p-2 rounded-lg bg-slate-800/30">
                <div class="flex items-center gap-2">
                  <span class="w-2 h-2 rounded-full ${u.user_id === state.user.id ? 'bg-indigo-500' : 'bg-emerald-500'}"></span>
                  <span class="text-sm font-medium truncate max-w-[120px] text-white">${u.name || '·∫®n danh'}</span>
                </div>
                <span class="text-xs text-slate-500">${u.user_id === state.user.id ? '(B·∫°n)' : ''}</span>
              </div>
            `).join('');
            
            $('#players-list').html(playerList || '<div class="text-slate-500 text-sm">Ch∆∞a c√≥ ng∆∞·ªùi ch∆°i</div>');
          })
          .on('broadcast', { event: 'game-event' }, ({ payload }) => {
            handleOnlineEvent(payload);
          })
          .on('error', () => {
            setConnectionStatus(false);
            reconnectRoom();
          })
          .subscribe(async (status) => {
            if (status === 'SUBSCRIBED') {
              await state.channel.track({
                user_id: state.user.id,
                name: state.user.name,
                joinedAt: Date.now()
              });
              setConnectionStatus(true);
              showLoading(4, 5);
            }
          });

        return true;
      } catch (e) {
        logger.error(e, 'setupRoom');
        showToast("L·ªói k·∫øt n·ªëi ph√≤ng");
        return false;
      }
    }

    function reconnectRoom() {
      if (state.reconnectAttempts >= state.MAX_RECONNECT_ATTEMPTS) {
        showToast("Kh√¥ng th·ªÉ k·∫øt n·ªëi l·∫°i ph√≤ng");
        return;
      }
      state.reconnectAttempts++;
      setTimeout(() => {
        if (state.channel) state.channel.unsubscribe();
        setupRoom(state.roomId, 'join'); // Gi·∫£ s·ª≠ join l·∫°i
      }, 2000);
    }

    function sendOnlineMove(move) {
      if (!state.channel) return;
      
      try {
        state.channel.send({
          type: 'broadcast',
          event: 'game-event',
          payload: { 
            type: 'move', 
            data: move, 
            sender: state.user.id,
            timestamp: Date.now()
          }
        });
      } catch (e) {
        logger.error(e, 'sendOnlineMove');
      }
    }

    function handleOnlineEvent(payload) {
      if (payload.sender === state.user.id) return;
      
      state.eventQueue.push(payload);
      if (!state.processingEvent) {
        processQueue();
      }
    }

    function processQueue() {
      if (state.processingEvent || state.eventQueue.length === 0) return;
      
      state.processingEvent = true;
      const evt = state.eventQueue.shift();
      
      try {
        switch(evt.type) {
          case 'move':
            if (state.game) {
              const tempGame = new Chess(state.game.fen());
              const possibleMoves = tempGame.moves({verbose: true});
              const isValid = possibleMoves.some(m => 
                m.from === evt.data.from && 
                m.to === evt.data.to
              );
              
              if (isValid) {
                state.game.move(evt.data);
                updateBoard();
                playSound('move');
              }
            }
            break;
            
          case 'chat':
            addChatMessage(evt.data.name, evt.data.text, false);
            break;
            
          case 'resign':
            if (state.game) {
              $('#endgame-title').text("TH·∫ÆNG");
              $('#endgame-desc').text("ƒê·ªëi th·ªß ƒë·∫ßu h√†ng");
              $('#endgame-modal').removeClass('hidden');
            }
            break;
        }
      } catch (e) {
        logger.error(e, 'processQueue');
      } finally {
        state.processingEvent = false;
        if (state.eventQueue.length > 0) {
          setTimeout(processQueue, 50);
        }
      }
    }

    // ==================== TIMER ====================
    function startTimer() {
      clearInterval(state.timerInterval);
      state.lastTick = Date.now();
      
      state.timerInterval = setInterval(() => {
        if (!state.game || state.game.game_over()) return;
        
        const now = Date.now();
        const delta = now - state.lastTick;
        state.lastTick = now;

        if (state.game.turn() === 'w') {
          state.whiteTime = Math.max(0, state.whiteTime - delta);
        } else {
          state.blackTime = Math.max(0, state.blackTime - delta);
        }

        if (state.whiteTime <= 0 || state.blackTime <= 0) {
          handleGameOver();
        }
        
        updateTimerUI();
      }, 100);
    }

    function updateTimerUI() {
      const fmt = (ms) => {
        const s = Math.floor(Math.max(0, ms) / 1000);
        const m = Math.floor(s / 60);
        const rs = s % 60;
        return `${m}:${rs.toString().padStart(2, '0')}`;
      };
      
      $('#timer-white').html(`Tr·∫Øng: <span class="text-emerald-300">${fmt(state.whiteTime)}</span>`);
      $('#timer-black').html(`ƒêen: <span class="text-emerald-300">${fmt(state.blackTime)}</span>`);
    }

    // ==================== INIT GAME ====================
    async function startGame(mode, roomId, action) {
      showLoadingOverlay(true);
      showLoading(1, 5);
      
      const name = $('#user-name-input').val().trim();
      if (!name) {
        showToast("Vui l√≤ng nh·∫≠p t√™n!");
        showLoadingOverlay(false);
        return;
      }
      
      state.user.name = name;
      localStorage.setItem('cp_name', name);
      
      unlockAudio();
      cleanupGame();
      state.game = new Chess();
      
      $('#landing-screen').addClass('hidden');
      $('#game-screen').removeClass('hidden').addClass('flex');
      $('#p-name-display').text(name);
      
      if (mode === 'ai') {
        $('#adv-bar').removeClass('hidden');
        state.mode = 'ai';
        state.role = 'white';
        state.orientation = 'white';
        
        const aiReady = await initStockfish();
        if (!aiReady) {
          showToast("Kh√¥ng th·ªÉ kh·ªüi t·∫°o AI");
          return;
        }
        
      } else if (mode === 'offline') {
        $('#adv-bar').addClass('hidden');
        state.mode = 'offline';
        state.role = 'both';
        state.orientation = 'white';
        
        initStockfish();
        
      } else if (mode === 'online') {
        $('#adv-bar').addClass('hidden');
        const roomReady = await setupRoom(roomId, action);
        if (!roomReady) {
          showToast("Kh√¥ng th·ªÉ tham gia ph√≤ng");
          return;
        }
      }
      
      showLoading(5, 5);
      
      setTimeout(() => {
        initBoard();
        startTimer();
        
        setTimeout(() => {
          showLoadingOverlay(false);
          showToast(`Ch√†o m·ª´ng ${name}!`);
        }, 500);
      }, 300);
    }

    // ==================== CHAT SYSTEM ====================
    function addChatMessage(name, text, isMe) {
      const bubbleClass = isMe 
        ? 'bg-indigo-600 text-white rounded-tr-none' 
        : 'bg-white/10 text-slate-200 rounded-tl-none border border-white/5';
      
      const align = isMe ? 'items-end' : 'items-start';
      const nameTag = isMe ? '' : `<span class="text-[10px] font-bold uppercase tracking-widest mb-1.5 text-slate-500">${name}</span>`;

      const html = `
      <div class="flex flex-col ${align} fade-in mb-3">
        ${nameTag}
        <div class="px-4 py-3 rounded-2xl text-[14px] max-w-[85%] shadow-md ${bubbleClass}">
          ${text}
        </div>
      </div>`;
      
      $('#chat-box').append(html);
      $('#chat-box').scrollTop($('#chat-box')[0].scrollHeight);
    }

    // ==================== UTILITIES ====================
    function showToast(msg) {
      const t = document.getElementById('toast');
      t.innerText = msg;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 3000);
    }

    function setConnectionStatus(online) {
      const el = document.getElementById('connection-status');
      if (online) {
        el.innerHTML = '<span class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-white animate-pulse"></span>ƒê√£ k·∫øt n·ªëi</span>';
        el.className = 'connection-status connection-online';
        setTimeout(() => el.classList.add('hidden'), 2000);
      } else {
        el.innerHTML = '<span class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span>M·∫•t k·∫øt n·ªëi...</span>';
        el.className = 'connection-status connection-offline';
        el.classList.remove('hidden');
      }
    }

    function cleanupGame() {
      if (state.timerInterval) {
        clearInterval(state.timerInterval);
        state.timerInterval = null;
      }
      
      if (state.stockfish && state.mode !== 'ai') {
        try {
          state.stockfish.terminate();
        } catch (e) {}
        state.stockfish = null;
      }
      
      if (state.channel) {
        try {
          state.channel.unsubscribe();
        } catch (e) {}
        state.channel = null;
      }
      
      state.eventQueue = [];
      state.processingEvent = false;
      state.game = null;
      state.board = null;
      state.whiteTime = 600000;
      state.blackTime = 600000;
    }

    // ==================== EVENT LISTENERS ====================
    $(document).ready(async () => {
      await initAudio();
      
      if (window.location.hostname.includes('localhost')) {
        document.getElementById('debug-panel').style.display = 'block';
      }
      
      $('#btn-create').click(() => {
        const id = Math.random().toString(36).substring(2, 8).toUpperCase();
        startGame('online', id, 'create');
      });
      
      $('#btn-join').click(() => {
        const id = $('#room-id-input').val().toUpperCase();
        if (!id || id.length < 4) {
          showToast("M√£ ph√≤ng ph·∫£i c√≥ √≠t nh·∫•t 4 k√Ω t·ª±!");
          return;
        }
        startGame('online', id, 'join');
      });
      
      $('#btn-watch').click(() => {
        const id = $('#room-id-input').val().toUpperCase();
        if (!id || id.length < 4) {
          showToast("M√£ ph√≤ng ph·∫£i c√≥ √≠t nh·∫•t 4 k√Ω t·ª±!");
          return;
        }
        startGame('online', id, 'watch');
      });
      
      $('#btn-ai').click(() => startGame('ai'));
      $('#btn-offline').click(() => startGame('offline'));
      
      $('#btn-home').click(() => {
        cleanupGame();
        location.reload();
      });
      
      $('#btn-flip').click(() => {
        if (state.board) {
          state.board.flip();
          state.orientation = state.orientation === 'white' ? 'black' : 'white';
        }
      });
      
      $('#btn-copy').click(() => {
        if (state.roomId) {
          navigator.clipboard.writeText(state.roomId)
            .then(() => showToast("ƒê√£ copy ID!"))
            .catch(() => showToast("L·ªói copy ID"));
        }
      });
      
      $('#btn-sound-toggle').click(() => {
        state.soundEnabled = !state.soundEnabled;
        const icon = $('#sound-icon')[0];
        if (state.soundEnabled) {
          icon.setAttribute('data-lucide', 'volume-2');
          showToast("√Çm thanh: B·∫¨T");
        } else {
          icon.setAttribute('data-lucide', 'volume-x');
          showToast("√Çm thanh: T·∫ÆT");
        }
        lucide.createIcons();
      });
      
      $('#btn-send').click(() => {
        const txt = $('#chat-input').val().trim();
        if (!txt) return;
        
        addChatMessage(state.user.name, txt, true);
        
        if (state.mode === 'online' && state.channel) {
          state.channel.send({
            type: 'broadcast',
            event: 'game-event',
            payload: { 
              type: 'chat', 
              data: { name: state.user.name, text: txt }, 
              sender: state.user.id 
            }
          });
        }
        
        $('#chat-input').val('');
      });
      
      $('#chat-input').keypress((e) => {
        if (e.which === 13) {
          $('#btn-send').click();
        }
      });
      
      $('#btn-replay').click(() => location.reload());
      $('#btn-analyze').click(() => {
        if (state.game) {
          navigator.clipboard.writeText(state.game.pgn())
            .then(() => showToast("ƒê√£ copy PGN!"))
            .catch(() => showToast("L·ªói copy PGN"));
        }
      });
      
      $('#btn-endgame-home').click(() => location.reload());
      
      ['q','r','b','n'].forEach(p => {
        $(`#promo-${p}-btn`).click(() => {
          $('#promotion-modal').addClass('hidden');
          if (state.pendingMove) {
            state.pendingMove.promotion = p;
            makeMove(state.pendingMove);
            state.pendingMove = null;
          }
        });
      });
      
      $('#user-name-input').val(state.user.name);
      
      if (!state.user.name) {
        $('#user-name-input').focus();
      }
      
      lucide.createIcons();
      
      setInterval(() => {
        $('#local-time').text(new Date().toLocaleTimeString('vi-VN', {hour:'2-digit', minute:'2-digit'}));
      }, 1000);
      
      $(window).on('beforeunload', () => {
        cleanupGame();
      });
      
      // Th√™m Visibility listener cho timer v√† anti-cheat
      document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
          clearInterval(state.timerInterval);
          // Anti-cheat logic here if implemented
        } else {
          startTimer();
        }
      });
      
      // Unlock audio on touch
      document.addEventListener('touchstart', unlockAudio);
    });

  })();
  </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9b59028e88fe0491',t:'MTc2NzAwODI5NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>